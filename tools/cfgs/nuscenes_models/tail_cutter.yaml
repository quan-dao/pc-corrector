CLASS_NAMES: ['car', 'bicycle', 'pedestrian']

DATA_CONFIG:
    _BASE_CONFIG_: ./cfgs/dataset_configs/nuscenes_dataset.yaml
    VERSION: 'v1.0-trainval'
    USE_MINI_TRAINVAL: True
    POINT_CLOUD_RANGE: [-51.2, -51.2, -5.0, 51.2, 51.2, 3.0]
    USE_HD_MAP: True
    NORMALIZE_LANE_ANGLE: False
    BEV_IMAGE_RESOLUTION: 0.2

    POSSIBLE_NUM_SWEEPS: [20]
    DROP_BACKGROUND:
        ENABLE: True
        DISTANCE_THRESHOLD: 10
        DROP_PROB: 0.4

    POINT_FEATURE_ENCODING: {
        encoding_type: absolute_coordinates_encoding,
        used_feature_list: ['x', 'y', 'z', 'intensity', 'timestamp', 'sweep_idx', 'instance_idx', 'aug_instance_idx',
                            'class_idx'],
        src_feature_list: ['x', 'y', 'z', 'intensity', 'timestamp', 'sweep_idx', 'instance_idx', 'aug_instance_idx',
                           'class_idx'],
    }

    DATA_AUGMENTOR:
        DISABLE_AUG_LIST: [ 'placeholder', 'gt_sampling' ]
        AUG_CONFIG_LIST:
            -   NAME: random_world_flip
                ALONG_AXIS_LIST: [ 'x', 'y' ]
                POINT_FEAT_TO_TRANSFORM: [ 5, 6 ]

            -   NAME: random_world_rotation
                WORLD_ROT_ANGLE: [ -0.3925, 0.3925 ]
                POINT_FEAT_TO_TRANSFORM: [ 5, 6 ]

            -   NAME: random_world_scaling
                WORLD_SCALE_RANGE: [ 0.95, 1.05 ]
                POINT_FEAT_TO_TRANSFORM: [ 5, 6 ]

    DATA_PROCESSOR:
        -   NAME: mask_points_and_boxes_outside_range
            REMOVE_OUTSIDE_BOXES: False

        -   NAME: shuffle_points
            SHUFFLE_ENABLED: {
                'train': True,
                'test': True
            }

        -   NAME: transform_points_to_voxels_placeholder
            VOXEL_SIZE: [0.2, 0.2, 8.0]

MODEL:
    NAME: Aligner

    PILLAR_ENCODER:
        POINT_CLOUD_RANGE: [ -51.2, -51.2, -5.0, 51.2, 51.2, 3.0 ]
        VOXEL_SIZE: [ 0.2, 0.2, 8.0 ]
        NUM_RAW_FEATURES: 5
        NUM_BEV_FEATURES: 64

    MAP_NET:
        ENABLE: True
        NAME: ResNetFPN  # or MapFusion
        NUM_MAP_LAYERS: 5  # drivable_area, walkway, pedcrossing, carpark_area, lane
        DROP_PROB: 0.3
        DROP_BLOCK_SIZE: 7
        MAP_FUSION_CHANNELS: [16, 16, 32, 32, 64, 64]  # MapFusion style
        # ResNetFPN
        NUM_FILTERS: [32, 64, 128]
        LAYERS_SIZE: [2, 2, 2]
        NUM_UP_FILTERS: [64, 32, 32, 32]

    BEV_BACKBONE:
        NAME: UNET2D
        DOWN_CHANNELS: [64, 64, 128, 128]  # 0-1-2-3
        UP_CHANNELS: [-1, 128, 128, 128, 64, 64]  # dummy-1-2-3-4-5
        UP_DEFORM_CONV: [-1, False, False, False, False, False]  # dummy-1-2-3-4-5

    ALIGNER_1ST_STAGE:
        NUM_SWEEPS: 20  # actually == MAX_SWEEPS
        HEAD_MID_CHANNELS: [128]

        INSTANCE_MID_CHANNELS: [128]
        INSTANCE_OUT_CHANNELS: 128
        INSTANCE_HEAD_USE_DROPOUT: True

        THRESH_MOTION: 1.0
        THRESH_FOREGROUND_PROB: 0.5

        CLUSTER:
            EPS: 1.5
            MIN_POINTS: 3

        LOSS:
            SEGMENTATION_LOSS: 'ce_lovasz'  # or 'ce_lovasz'

        FREEZE_WEIGHTS: False
        REAL_INFERENCE: False
        DEBUG: False

    ALIGNER_HEAD:
        ENABLE: False
        ATTENTION_STACK:
            EMBED_DIM: 256
            LOCAL_NUM_HEADS: 8
            LOCAL_NUM_LAYERS: 4
            GLOBAL_NUM_HEADS: 8
            GLOBAL_NUM_LAYERS: 4

        DECODER:
            OBJECT_HIDDEN_CHANNELS: [128]
            TRAJECTORY_HIDDEN_CHANNELS: [512]
            TRAJECTORY_NUM_WAYPOINTS: 30

        DEBUG: False

    POST_PROCESSING:
        RECALL_THRESH_LIST: [ 0.3, 0.5, 0.7 ]
        EVAL_METRIC: kitti

OPTIMIZATION:
    BATCH_SIZE_PER_GPU: 4
    NUM_EPOCHS: 20

    OPTIMIZER: adam_onecycle
    LR: 0.001
    WEIGHT_DECAY: 0.01
    MOMENTUM: 0.9

    MOMS: [ 0.95, 0.85 ]
    PCT_START: 0.4
    DIV_FACTOR: 10
    DECAY_STEP_LIST: [ 35, 45 ]
    LR_DECAY: 0.1
    LR_CLIP: 0.0000001

    LR_WARMUP: False
    WARMUP_EPOCH: 1

    GRAD_NORM_CLIP: 10
